async function checkQueue() {
  const urls = ['https://www.pokemoncenter.com/','https://www.pokemoncenter.com/en-ca/','https://www.pokemoncenter.com/en-gb/'];
  for (let url of urls) {
    try {
      const html = await (await fetch(`https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`)).text();
      if (html.toLowerCase().includes('queueit') || html.includes('virtual queue')) return true;
    } catch(e) {}
  }
  return false;
}

async function updateFeed() {
  try {
    const data = await (await fetch('https://api.allorigins.win/get?url='+encodeURIComponent(
      'https://rsshub.app/twitter/search/pokemon%20center%20(queue%20OR%20drop%20OR%20restock%20OR%20live)'
    ))).json();
    const parser = new DOMParser();
    const xml = parser.parseFromString(data.contents,'text/xml');
    const items = Array.from(xml.querySelectorAll('item')).slice(0,8);
    document.getElementById('feed').innerHTML = items.map(i=>{
      const title = i.querySelector('title').textContent;
      const age = Math.round((Date.now()-new Date(i.querySelector('pubDate').textContent))/60000);
      return `<div class="intel-item ${age<6?'fresh':''}">${title} â€¢ <small>${age}m ago</small></div>`;
    }).join('');
  } catch(e) {}
}

setInterval(async()=>{
  const live = await checkQueue();
  const q = document.getElementById('queue');
  const icon = document.getElementById('queueIcon');
  const label = document.getElementById('queueLabel');
  if(live && !q.classList.contains('live')){
    icon.textContent='Red Circle'; label.textContent='QUEUE LIVE';
    q.classList.add('live');
    sound.play();
  } else if(!live && q.classList.contains('live')){
    icon.textContent='Green Circle'; label.textContent='NO QUEUE';
    q.classList.remove('live');
  }
  updateFeed();
},10000);
